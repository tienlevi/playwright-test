name: Upload Image to Release and Comment on Pull Request

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  upload-and-comment:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required for uploading release assets
      pull-requests: write # Required for commenting on pull requests
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: pr-${{ github.event.pull_request.number }}-release
          release_name: PR #${{ github.event.pull_request.number }} Release
          draft: false
          prerelease: true

      - name: Upload Image and Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs').promises;
            const path = require('path');

            const imagePath = 'path/to/your/image.png'; // Update to your image file path
            const imageName = path.basename(imagePath);

            try {
              // Read the image file
              const imageData = await fs.readFile(imagePath);

              // Upload the image as a release asset
              const uploadResponse = await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: ${{ steps.create-release.outputs.id }},
                name: imageName,
                data: imageData,
                headers: {
                  'content-type': 'image/png' // Adjust based on image type
                }
              });

              // Comment on the pull request with the image link
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `Uploaded image to release: [${imageName}](${uploadResponse.data.browser_download_url})`
              });

              console.log(`Successfully uploaded ${imageName} to release and commented on PR #${context.payload.pull_request.number}`);
            } catch (error) {
              core.setFailed(`Failed to upload image or comment: ${error.message}`);
            }
